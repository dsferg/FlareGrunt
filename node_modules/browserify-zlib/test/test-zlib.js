function BufferStream(){this.chunks=[],this.length=0,this.writable=!0,this.readable=!0}function SlowStream(trickle){this.trickle=trickle,this.offset=0,this.readable=this.writable=!0}var assert=require("assert"),zlib=require("../"),path=require("path"),zlibPairs=[[zlib.Deflate,zlib.Inflate],[zlib.Gzip,zlib.Gunzip],[zlib.Deflate,zlib.Unzip],[zlib.Gzip,zlib.Unzip],[zlib.DeflateRaw,zlib.InflateRaw]],trickle=[128,1024,1048576],chunkSize=[128,1024,16384,1048576],level=[-1,0,1,2,3,4,5,6,7,8,9],windowBits=[8,9,10,11,12,13,14,15],memLevel=[1,2,3,4,5,6,7,8,9],strategy=[0,1,2,3,4];process.env.PUMMEL||(trickle=[1024],chunkSize=[16384],level=[6],memLevel=[8],windowBits=[15],strategy=[0]);var fs=require("fs");process.env.FAST&&(zlibPairs=[[zlib.Gzip,zlib.Unzip]]);var tests={"person.jpg":fs.readFileSync(__dirname+"/fixtures/person.jpg"),"elipses.txt":fs.readFileSync(__dirname+"/fixtures/elipses.txt"),"empty.txt":fs.readFileSync(__dirname+"/fixtures/empty.txt")},util=require("util"),stream=require("stream");util.inherits(BufferStream,stream.Stream),BufferStream.prototype.write=function(c){return this.chunks.push(c),this.length+=c.length,!0},BufferStream.prototype.end=function(c){c&&this.write(c);var buf=new Buffer(this.length),i=0;return this.chunks.forEach(function(c){c.copy(buf,i),i+=c.length}),this.emit("data",buf),this.emit("end"),!0},util.inherits(SlowStream,stream.Stream),SlowStream.prototype.write=function(){throw new Error("not implemented, just call ss.end(chunk)")},SlowStream.prototype.pause=function(){this.paused=!0,this.emit("pause")},SlowStream.prototype.resume=function(){function emit(){if(!self.paused){if(self.offset>=self.length)return self.ended=!0,self.emit("end");var end=Math.min(self.offset+self.trickle,self.length),c=self.chunk.slice(self.offset,end);self.offset+=c.length,self.emit("data",c),process.nextTick(emit)}}var self=this;self.ended||(self.emit("resume"),self.chunk&&(self.paused=!1,emit()))},SlowStream.prototype.end=function(chunk){var self=this;return self.chunk=chunk,self.length=chunk.length,self.resume(),self.ended};var tape=require("tape");Object.keys(tests).forEach(function(file){var test=tests[file];chunkSize.forEach(function(chunkSize){trickle.forEach(function(trickle){windowBits.forEach(function(windowBits){level.forEach(function(level){memLevel.forEach(function(memLevel){strategy.forEach(function(strategy){zlibPairs.forEach(function(pair){var Def=pair[0],Inf=pair[1],opts={level:level,windowBits:windowBits,memLevel:memLevel,strategy:strategy};tape("zlib "+file+" "+chunkSize+" "+JSON.stringify(opts)+" "+Def.name+" -> "+Inf.name,function(t){t.plan(1);var def=new Def(opts),inf=new Inf(opts),ss=new SlowStream(trickle),buf=new BufferStream;buf.on("data",function(c){t.deepEqual(c,test)}),ss.pipe(def).pipe(inf).pipe(buf),ss.end(test)})})})})})})})})});