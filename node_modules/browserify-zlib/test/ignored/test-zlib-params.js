var common=require("../common.js"),assert=require("assert"),zlib=require("zlib"),path=require("path"),fs=require("fs"),file=fs.readFileSync(path.resolve(common.fixturesDir,"person.jpg")),chunkSize=24576,opts={level:9,strategy:zlib.Z_DEFAULT_STRATEGY},deflater=zlib.createDeflate(opts),chunk1=file.slice(0,chunkSize),chunk2=file.slice(chunkSize),blkhdr=new Buffer([0,72,130,183,125]),expected=Buffer.concat([blkhdr,chunk2]),actual;deflater.write(chunk1,function(){for(deflater.params(0,zlib.Z_DEFAULT_STRATEGY,function(){for(;deflater.read(););deflater.end(chunk2,function(){for(var buf,bufs=[];buf=deflater.read();)bufs.push(buf);actual=Buffer.concat(bufs)})});deflater.read(););}),process.once("exit",function(){assert.deepEqual(actual,expected)});