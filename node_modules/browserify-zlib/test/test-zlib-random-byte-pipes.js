function RandomReadStream(opt){Stream.call(this),this.readable=!0,this._paused=!1,this._processing=!1,this._hasher=crypto.createHash("sha1"),opt=opt||{},opt.block=opt.block||262144,opt.total=opt.total||268435456,this._remaining=opt.total,opt.jitter=opt.jitter||1024,this._opt=opt,this._process=this._process.bind(this),process.nextTick(this._process)}function HashStream(){Stream.call(this),this.readable=this.writable=!0,this._hasher=crypto.createHash("sha1")}var crypto=require("crypto"),stream=require("stream"),Stream=stream.Stream,util=require("util"),tape=require("tape"),zlib=require("../");util.inherits(RandomReadStream,Stream),RandomReadStream.prototype.pause=function(){this._paused=!0,this.emit("pause")},RandomReadStream.prototype.resume=function(){this._paused=!1,this.emit("resume"),this._process()},RandomReadStream.prototype._process=function(){if(!this._processing&&!this._paused){if(this._processing=!0,!this._remaining)return this._hash=this._hasher.digest("hex").toLowerCase().trim(),this._processing=!1,void this.emit("end");var block=this._opt.block,jitter=this._opt.jitter;jitter&&(block+=Math.ceil(Math.random()*jitter-jitter/2)),block=Math.min(block,this._remaining);for(var buf=new Buffer(block),i=0;i<block;i++)buf[i]=256*Math.random();this._hasher.update(buf),this._remaining-=block,this._processing=!1,this.emit("data",buf),process.nextTick(this._process)}},util.inherits(HashStream,Stream),HashStream.prototype.write=function(c){return this._hasher.update(c),process.nextTick(this.resume.bind(this)),!1},HashStream.prototype.resume=function(){this.emit("resume"),process.nextTick(this.emit.bind(this,"drain"))},HashStream.prototype.end=function(c){c&&this.write(c),this._hash=this._hasher.digest("hex").toLowerCase().trim(),this.emit("data",this._hash),this.emit("end")},tape("random byte pipes",function(t){var inp=new RandomReadStream({total:1024,block:256,jitter:16}),out=new HashStream,gzip=zlib.createGzip(),gunz=zlib.createGunzip();inp.pipe(gzip).pipe(gunz).pipe(out),inp.on("data",function(c){t.ok(c.length)}),gzip.on("data",function(c){t.ok(c.length)}),gunz.on("data",function(c){t.ok(c.length)}),out.on("data",function(c){t.ok(c.length)}),out.on("data",function(c){t.ok(c.length),t.equal(c,inp._hash,"hashes should match")}),out.on("end",function(){t.end()})});